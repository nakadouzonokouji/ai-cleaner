const fs = require('fs');
const path = require('path');

// 掃除手順データ（簡略版 - bathrooom, toilet, living, floor, windowのみ）
const cleaningSteps = {
    'bathroom': {
        'bathtub-light': {
            steps: [
                '浴槽の栓を抜いて水を流す',
                '中性洗剤をスポンジに含ませる',
                '浴槽全体を円を描くように洗う',
                '特に水位線の汚れを重点的に',
                'シャワーで洗剤を流す',
                '乾いた布で水滴を拭き取る',
                'エプロン部分も忘れずに清掃',
                '排水口の髪の毛を取り除く',
                '仕上げに防カビスプレー',
                '換気扇を回して乾燥'
            ]
        },
        'bathtub-heavy': {
            steps: [
                '換気扇を強で回し、窓を全開',
                '浴槽に熱めのお湯を張る',
                '重曹を1カップ投入して溶かす',
                '風呂釜洗浄剤を追加して循環',
                '2時間程度放置して汚れを分解',
                '水を抜いてカビキラーを噴射',
                'ブラシで頑固な汚れをこする',
                '高圧シャワーで洗い流す',
                'クエン酸で仕上げ洗い',
                '完全に乾燥させてカビ予防'
            ]
        },
        'shower-light': {
            steps: [
                'シャワーヘッドを取り外す',
                '中性洗剤で水栓全体を洗う',
                'スポンジで優しくこする',
                '歯ブラシで細かい部分を清掃',
                'クエン酸で水垢を除去',
                '水でよくすすぐ',
                '乾いた布で磨き上げる',
                'シャワーホースも忘れずに',
                'シャワーヘッドを元に戻す',
                '水漏れがないか確認'
            ]
        },
        'shower-heavy': {
            steps: [
                '止水栓を閉めて水を止める',
                'シャワーヘッドを分解',
                'クエン酸水に部品を浸け置き（1時間）',
                '水栓本体のカルキをヘラで削る',
                'サンポールで頑固な水垢を除去',
                '目詰まりを針で丁寧に取る',
                'パッキンを確認して交換',
                '部品を洗浄して組み立て',
                '止水栓を開けて水漏れ確認',
                '防カビコーティングで仕上げ'
            ]
        },
        'toilet-light': {
            steps: [
                'トイレ用洗剤を便器内に噴射',
                '5分程度置いて汚れを浮かせる',
                'トイレブラシで便器内を洗う',
                '便座を持ち上げて裏側も清掃',
                'タンク上部の手洗い部分を拭く',
                '床を除菌シートで拭く',
                'ペーパーホルダーを拭き掃除',
                'ドアノブも忘れずに除菌',
                '換気扇フィルターの確認',
                '芳香剤を新しいものに交換'
            ]
        },
        'toilet-heavy': {
            steps: [
                '窓を開けて換気扇を回す',
                'サンポールなど酸性洗剤を準備',
                '便器内の水位を下げる',
                '尿石に洗剤を直接かける',
                'トイレットペーパーでパック',
                '30分～1時間放置',
                '硬めのブラシで尿石を削る',
                'タンク内も洗浄剤で清掃',
                '床の黒ずみをメラミンスポンジで',
                '全体を除菌して仕上げ'
            ]
        },
        'washstand-light': {
            steps: [
                '洗面台の物を片付ける',
                '中性洗剤をスポンジに含ませる',
                '洗面ボウルを円を描くように洗う',
                '水栓周りの水垢を除去',
                '鏡を専用クリーナーで拭く',
                '排水口のゴミを取る',
                'キャビネット内を整理',
                'タオル掛けを拭き掃除',
                '床の髪の毛を掃除',
                '最後に全体を乾拭き'
            ]
        },
        'washstand-heavy': {
            steps: [
                '換気扇を回して窓を開ける',
                '排水口の部品を全て外す',
                'カビキラーでカビを除去',
                'クレンザーで黄ばみを研磨',
                '歯ブラシで目地の汚れを掃除',
                'パイプユニッシュで排水管洗浄',
                '鏡のウロコをダイヤモンドパッドで',
                '水栓のカルキをクエン酸で除去',
                '防カビ剤を塗布',
                '全体を磨いて仕上げ'
            ]
        },
        'drain-light': {
            steps: [
                '排水口のフタを外す',
                'ゴミ受けの髪の毛を取る',
                '中性洗剤をかけて5分置く',
                'ブラシでヌメリを落とす',
                '部品を水洗いする',
                '排水口内部も掃除',
                'パイプクリーナーを流す',
                '熱めのお湯で流す',
                '部品を元に戻す',
                '消臭剤を設置'
            ]
        },
        'drain-heavy': {
            steps: [
                '換気を十分に確保',
                '排水口の全部品を取り外す',
                '重曹とクエン酸を投入',
                '発泡させて30分放置',
                'ワイヤーブラシで配管清掃',
                '高圧洗浄機があれば使用',
                'パイプユニッシュを規定量投入',
                '1時間以上放置して分解',
                '大量の水で押し流す',
                '詰まりが解消されたか確認'
            ]
        },
        'ventilation-light': {
            steps: [
                '換気扇の電源を切る',
                'カバーを外す',
                'フィルターを取り出す',
                '掃除機でホコリを吸う',
                '中性洗剤で洗う',
                '水でよくすすぐ',
                '水気を切って乾燥',
                'ファン部分も拭き掃除',
                'フィルターを戻す',
                'カバーを取り付けて完了'
            ]
        },
        'ventilation-heavy': {
            steps: [
                'ブレーカーを落とす',
                '換気扇を分解',
                '部品を重曹水に浸ける',
                'カビキラーでカビを除去',
                'ファンの汚れをヘラで削る',
                'モーター周りを乾拭き',
                'ダクト内も可能な範囲で清掃',
                '部品を洗浄して乾燥',
                '元通りに組み立て',
                'ブレーカーを戻して動作確認'
            ]
        }
    },
    'toilet': {
        'toilet-light': {
            steps: [
                'トイレ用洗剤を便器内に噴射',
                '便器のフチ裏まで洗剤をかける',
                '5分程度置いて汚れを浮かせる',
                'トイレブラシで優しくこする',
                '便座と便蓋を上げて清掃',
                'ウォシュレットノズルを掃除',
                'タンク上部を拭き掃除',
                '便座の裏側も忘れずに',
                '全体を水で流す',
                '除菌スプレーで仕上げ'
            ]
        },
        'toilet-heavy': {
            steps: [
                '窓を開けて換気扇を最大に',
                'トイレの水位を下げる',
                'サンポールを尿石に直接塗布',
                'トイレットペーパーでパック',
                '1時間以上放置して浸透させる',
                '硬めのブラシで尿石を削る',
                'タンク内に洗浄剤を投入',
                'ウォシュレット内部も洗浄',
                '便座の隙間の汚れを除去',
                '全体を水洗いして仕上げ'
            ]
        },
        'floor-light': {
            steps: [
                'トイレマットを外す',
                '掃除機で髪の毛やホコリを吸う',
                '除菌シートで床を拭く',
                '便器周りを重点的に',
                '壁の下部分を拭き上げる',
                '巾木の汚れも除去',
                'ドア枠周辺も清掃',
                'トイレブラシ入れも掃除',
                'マットを洗濯または交換',
                '芳香剤を新しくする'
            ]
        },
        'floor-heavy': {
            steps: [
                '窓全開で換気扇を回す',
                'トイレ用強力洗剤を準備',
                '床全体に洗剤をスプレー',
                '10分置いて汚れを分解',
                'メラミンスポンジで黒ずみ除去',
                '壁の黄ばみをクレンザーで',
                'ブラックライトで尿跡確認',
                '見えない汚れも徹底除去',
                '床用ワックスで保護',
                '防臭・防汚コーティング'
            ]
        }
    },
    'living': {
        'sofa-light': {
            steps: [
                'クッションを外して掃除機かけ',
                '隙間のゴミを丁寧に吸い取る',
                '布用クリーナーをスプレー',
                '柔らかいブラシで優しくこする',
                '汚れた部分を濡れタオルで拭く',
                '乾いたタオルで水分を取る',
                'クッションカバーは洗濯',
                '革製品は専用クリーナーで',
                '消臭スプレーで仕上げ',
                '十分に乾燥させる'
            ]
        },
        'sofa-heavy': {
            steps: [
                'ソファを移動して裏側も確認',
                '掃除機で全体のホコリを除去',
                '重曹水をスプレーして放置',
                'スチームクリーナーで汚れを浮かす',
                'シミ抜き剤で頑固なシミを処理',
                'ペット臭は酵素系クリーナーで',
                'カビはアルコールで除菌',
                'リンスクリーナーがあれば使用',
                '扇風機で強制乾燥',
                '防汚スプレーでコーティング'
            ]
        },
        'carpet-light': {
            steps: [
                '表面のゴミを粘着ローラーで取る',
                '掃除機を縦横にかける',
                '重曹を全体に振りかける',
                '30分放置して臭いを吸収',
                '掃除機で重曹を吸い取る',
                'シミは中性洗剤で部分洗い',
                '固く絞った雑巾で拭く',
                '窓を開けて換気',
                'ブラシで毛並みを整える',
                '完全に乾燥させる'
            ]
        },
        'carpet-heavy': {
            steps: [
                'カーペットを裏返して叩く',
                '強力掃除機で深部の汚れを吸引',
                'カーペットクリーナーをたっぷり',
                'ブラシマシンがあれば使用',
                'スチームクリーナーで洗浄',
                'リンスクリーナーで洗剤除去',
                '高圧洗浄機で屋外洗い（可能なら）',
                '除菌・消臭剤をスプレー',
                '扇風機とエアコンで強制乾燥',
                '防ダニ・防カビ加工'
            ]
        },
        'table-light': {
            steps: [
                'テーブル上の物を片付ける',
                '乾いた布でホコリを払う',
                '材質に合った洗剤を選ぶ',
                '固く絞った布で拭き上げる',
                'ガラスは専用クリーナーで',
                '木製は専用ワックスで保護',
                '脚や裏側も忘れずに',
                '引き出しの中も整理',
                '取っ手部分を除菌',
                '最後に乾拭きで仕上げ'
            ]
        },
        'table-heavy': {
            steps: [
                '家具を移動して全体を確認',
                'へこみは湿らせたタオルとアイロンで',
                '油性マジックはアルコールで除去',
                'シールはドライヤーで温めて剥がす',
                '深い汚れはサンドペーパーで研磨',
                'キズは補修ペンで目立たなく',
                'カビはアルコールで完全除菌',
                '金属部分はサビ取り剤で',
                '全体を専用クリーナーで仕上げ',
                '保護ワックスを塗布'
            ]
        },
        'wall-light': {
            steps: [
                'ハンディモップでホコリを払う',
                '掃除機のブラシでクモの巣除去',
                '中性洗剤を薄めた液を準備',
                'スポンジに含ませて固く絞る',
                '下から上へ向かって拭く',
                '汚れた部分は重点的に',
                'きれいな水で洗剤を拭き取る',
                '乾いた布で水分を除去',
                'エアコン周りも忘れずに',
                '換気して完全に乾燥'
            ]
        },
        'wall-heavy': {
            steps: [
                '家具を壁から離す',
                '重曹ペーストを汚れに塗布',
                'メラミンスポンジで優しくこする',
                'タバコのヤニはアルカリ洗剤で',
                'カビは希釈した塩素系漂白剤で',
                'クレヨンは消しゴムとアルコールで',
                '油性ペンは除光液で慎重に',
                'シミが残る部分は補修ペイント',
                '全体をきれいな水で拭き上げ',
                '防カビ剤をスプレー'
            ]
        }
    },
    'floor': {
        'flooring-light': {
            steps: [
                'ドライモップでホコリを取る',
                '掃除機で細かいゴミを吸引',
                '固く絞った雑巾で拭き掃除',
                '中性洗剤を薄めて使用',
                '木目に沿って拭く',
                '水拭き後は乾拭き必須',
                '月1回はワックスがけ',
                '家具の下も忘れずに',
                'ドアの開閉部分は特に丁寧に',
                '最後に換気して乾燥'
            ]
        },
        'flooring-heavy': {
            steps: [
                '家具を移動して全面露出',
                'ワックス剥離剤で古いワックス除去',
                'アルカリ洗剤で油汚れを分解',
                'スチームモップで頑固な汚れ除去',
                'へこみは水とアイロンで修復',
                '深い傷は補修材で埋める',
                'サンドペーパーで表面を整える',
                '全体を中性洗剤で洗浄',
                '完全乾燥後に新しいワックス',
                '家具を戻して完了'
            ]
        },
        'tatami-light': {
            steps: [
                '畳の目に沿って掃き掃除',
                '掃除機も目に沿って優しく',
                '固く絞った雑巾で拭く',
                'から拭きで水分を除去',
                '酢水で除菌効果',
                '畳の縁も丁寧に',
                'ダニ予防スプレー',
                '風通しを良くする',
                '重い家具の跡をチェック',
                '定期的に畳干し'
            ]
        },
        'tatami-heavy': {
            steps: [
                '畳を外して天日干し（可能なら）',
                'カビはアルコールで除菌',
                '重曹で臭いの元を吸収',
                'ダニは専用燻煙剤で駆除',
                'シミは薄めた漂白剤で',
                '焦げ跡はサンドペーパーで研磨',
                '全体を消毒用エタノールで拭く',
                '扇風機で強制乾燥',
                '防虫シートを敷いて畳を戻す',
                '定期的な換気を心がける'
            ]
        },
        'carpet-light': {
            steps: [
                '粘着ローラーで表面の汚れ取り',
                '掃除機を念入りにかける',
                '重曹をまんべんなく振りかける',
                '1時間放置して臭い吸収',
                '再度掃除機で吸い取る',
                '部分的なシミは中性洗剤で',
                'ブラシで毛並みを整える',
                '消臭スプレーをかける',
                '窓を開けて十分に換気',
                '定期的にクリーニング'
            ]
        },
        'carpet-heavy': {
            steps: [
                'カーペットを外して裏側確認',
                '高圧洗浄機で丸洗い（屋外）',
                'カーペットシャンプーで洗浄',
                'リンスで洗剤成分を除去',
                'ペット臭は酵素クリーナーで',
                'カビは塩素系漂白剤で除去',
                'スチームクリーナーで仕上げ',
                '除菌消臭剤をたっぷり',
                '天日干しまたは乾燥機',
                '防ダニ・防カビスプレー'
            ]
        },
        'tile-light': {
            steps: [
                'ほうきで大きなゴミを掃く',
                '掃除機で細かいホコリ除去',
                '中性洗剤をバケツに準備',
                'モップで全体を拭き掃除',
                '目地はブラシでこする',
                'きれいな水で洗剤を流す',
                '乾いたモップで水分除去',
                'タイル用ワックスで保護',
                '換気して完全乾燥',
                '定期的なメンテナンス'
            ]
        },
        'tile-heavy': {
            steps: [
                '家具を全て移動',
                'アルカリ洗剤で油汚れ分解',
                'スチームクリーナーで汚れを浮かす',
                '目地は専用ブラシで徹底洗浄',
                'カビは塩素系カビ取り剤で',
                '頑固な汚れは研磨剤使用',
                '高圧洗浄機で一気に流す',
                '目地の補修が必要なら実施',
                'コーティング剤で仕上げ',
                '防カビ対策を施す'
            ]
        }
    },
    'window': {
        'glass-light': {
            steps: [
                '窓枠のホコリを払う',
                'ガラスクリーナーをスプレー',
                'マイクロファイバークロスで拭く',
                '上から下へ一定方向に',
                '水拭きで洗剤を除去',
                '乾いた布で仕上げ拭き',
                '窓枠も忘れずに清掃',
                'サッシ溝の汚れも除去',
                '網戸も一緒に掃除',
                '最後に全体をチェック'
            ]
        },
        'glass-heavy': {
            steps: [
                '安全対策を万全にする',
                'こびりついた汚れをスクレーパーで',
                'アルカリ洗剤で油膜除去',
                'タバコのヤニは重曹ペーストで',
                'ウロコ状の水垢はクエン酸で',
                'スチームクリーナーで頑固な汚れ',
                'ダイヤモンドパッドで研磨',
                '大量の水で洗い流す',
                'スクイージーで水切り',
                '撥水コーティングで仕上げ'
            ]
        },
        'sash-light': {
            steps: [
                'ブラシで大きなゴミを掃く',
                '掃除機で細かいゴミ吸引',
                '歯ブラシで溝の汚れ取り',
                '中性洗剤で全体を洗浄',
                '水拭きで洗剤を除去',
                '乾いた布で水分拭き取り',
                'レール部分も丁寧に',
                'ゴムパッキンのカビチェック',
                '潤滑スプレーで動き改善',
                '戸車の動作確認'
            ]
        },
        'sash-heavy': {
            steps: [
                '窓を外せる場合は外す',
                'こびりついた汚れをヘラで削る',
                'サビは専用除去剤で処理',
                'カビはカビキラーで除菌',
                '高圧洗浄機で汚れを吹き飛ばす',
                'パッキンの劣化部分は交換',
                '金属部分は研磨剤で磨く',
                '防錆スプレーで保護',
                'コーキングの補修',
                '組み立てて動作確認'
            ]
        }
    }
};

// HTMLファイルに掃除手順を追加する関数
function addCleaningSteps(filePath) {
    try {
        let html = fs.readFileSync(filePath, 'utf8');
        
        // すでに掃除手順があるかチェック
        if (html.includes('<h2>掃除手順</h2>')) {
            return 'already_exists';
        }
        
        const pathParts = filePath.split(path.sep);
        const location = pathParts[pathParts.length - 2];
        const fileName = pathParts[pathParts.length - 1];
        const cleaningType = fileName.replace('.html', '');
        
        // 掃除手順データを取得
        if (!cleaningSteps[location] || !cleaningSteps[location][cleaningType]) {
            return 'no_data';
        }
        
        const stepData = cleaningSteps[location][cleaningType];
        
        // 掃除手順セクションを生成
        const stepsSection = `        <div class="section">
            <h2>掃除手順</h2>
${stepData.steps.map((step, index) => `            <div class="step">
                <span class="step-number">${index + 1}</span>
                <span>${step}</span>
            </div>`).join('\n')}
        </div>`;
        
        // 適切な挿入位置を探す
        // パターン1: 詳細掃除手順セクションの後
        let insertRegex = /(<div class="section">[\s\S]*?<h2>詳細掃除手順<\/h2>[\s\S]*?<\/div>)\s*\n/;
        if (insertRegex.test(html)) {
            html = html.replace(insertRegex, `$1\n        \n${stepsSection}\n        \n`);
            fs.writeFileSync(filePath, html, 'utf8');
            return 'added_after_detail';
        }
        
        // パターン2: 最初のproductsセクションの前
        insertRegex = /(\s*)(<div class="section">[\s\S]*?<h2>必要な掃除アイテム<\/h2>)/;
        if (insertRegex.test(html)) {
            html = html.replace(insertRegex, `$1${stepsSection}\n$1\n$1$2`);
            fs.writeFileSync(filePath, html, 'utf8');
            return 'added_before_products';
        }
        
        // パターン3: container divの最後の前
        insertRegex = /(\s*)(<\/div>\s*<\/body>)/;
        if (insertRegex.test(html)) {
            html = html.replace(insertRegex, `\n${stepsSection}\n$1$2`);
            fs.writeFileSync(filePath, html, 'utf8');
            return 'added_at_end';
        }
        
        return 'no_insert_point';
        
    } catch (error) {
        console.error(`エラー: ${error.message}`);
        return 'error';
    }
}

// メイン処理
console.log('掃除手順を追加中...\n');

const locations = ['bathroom', 'toilet', 'living', 'floor', 'window'];
const stats = {
    already_exists: 0,
    added_after_detail: 0,
    added_before_products: 0,
    added_at_end: 0,
    no_data: 0,
    no_insert_point: 0,
    error: 0
};

locations.forEach(location => {
    const locationPath = path.join(__dirname, location);
    
    if (!fs.existsSync(locationPath)) {
        console.log(`⚠️  ディレクトリなし: ${location}`);
        return;
    }
    
    console.log(`\n=== ${location} ===`);
    
    const files = fs.readdirSync(locationPath);
    files.forEach(file => {
        if (file.match(/-(light|heavy)\.html$/)) {
            const filePath = path.join(locationPath, file);
            console.log(`処理中: ${file}`);
            
            const result = addCleaningSteps(filePath);
            stats[result]++;
            
            switch(result) {
                case 'already_exists':
                    console.log('  → すでに掃除手順あり');
                    break;
                case 'added_after_detail':
                    console.log('  ✅ 詳細手順の後に追加');
                    break;
                case 'added_before_products':
                    console.log('  ✅ 商品セクションの前に追加');
                    break;
                case 'added_at_end':
                    console.log('  ✅ 最後に追加');
                    break;
                case 'no_data':
                    console.log('  ⚠️  掃除手順データなし');
                    break;
                case 'no_insert_point':
                    console.log('  ❌ 挿入位置が見つからない');
                    break;
                case 'error':
                    console.log('  ❌ エラー発生');
                    break;
            }
        }
    });
});

console.log('\n\n=== 統計 ===');
console.log(`既存: ${stats.already_exists} ファイル`);
console.log(`追加成功: ${stats.added_after_detail + stats.added_before_products + stats.added_at_end} ファイル`);
console.log(`  - 詳細後: ${stats.added_after_detail}`);
console.log(`  - 商品前: ${stats.added_before_products}`);
console.log(`  - 最後: ${stats.added_at_end}`);
console.log(`データなし: ${stats.no_data} ファイル`);
console.log(`挿入位置なし: ${stats.no_insert_point} ファイル`);
console.log(`エラー: ${stats.error} ファイル`);