<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メモリテスト - Rinker方式実装</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .memory-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f8f8f8;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .product-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .product-price {
            color: #b71c1c;
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        .product-rating {
            color: #ff9800;
            margin-bottom: 5px;
        }
        .product-meta {
            font-size: 0.9em;
            color: #666;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 16px;
        }
        button:hover {
            background: #1976d2;
        }
        .category-filter {
            margin-bottom: 20px;
        }
        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rinker方式 メモリテスト</h1>
        
        <div class="memory-info" id="memoryInfo">
            メモリ情報を計測中...
        </div>

        <div class="controls">
            <button onclick="loadProducts()">商品を読み込む</button>
            <button onclick="clearProducts()">クリア</button>
            <button onclick="checkMemory()">メモリ確認</button>
            <button onclick="stressTest()">ストレステスト (1000回ロード)</button>
        </div>

        <div class="category-filter">
            <label for="categorySelect">カテゴリーフィルター:</label>
            <select id="categorySelect" onchange="filterProducts()">
                <option value="all">すべて</option>
                <option value="kitchen-sink">キッチン・シンク</option>
                <option value="bathroom-bathtub">お風呂・浴槽</option>
                <option value="living-carpet">リビング・カーペット</option>
                <option value="floor-flooring">床・フローリング</option>
                <option value="toilet-toilet">トイレ</option>
                <option value="window-glass">窓・ガラス</option>
            </select>
        </div>

        <div id="status"></div>
        <div id="productContainer" class="product-grid"></div>
    </div>

    <script>
        // 商品マスターデータを直接埋め込み
        const masterProductsData = {
            "products": [
                {
                    "id": "B08N5WRWNW",
                    "category": "kitchen-sink",
                    "name": "Echo Show 8 (第2世代) - HDスマートディスプレイ",
                    "price": 14980,
                    "rating": 4.3,
                    "reviews": 15234,
                    "image": "https://m.media-amazon.com/images/I/51UZ17lvVFL._AC_SL1000_.jpg",
                    "description": "8インチHDタッチスクリーン、13メガピクセルカメラ、自動フレーミング機能付き",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B08N5WRWNW"
                },
                {
                    "id": "B07Q9MJKBV",
                    "category": "bathroom-bathtub",
                    "name": "風呂水ワンダー 翌日も風呂水キレイ",
                    "price": 298,
                    "rating": 4.1,
                    "reviews": 8976,
                    "image": "https://m.media-amazon.com/images/I/71VxFJI6gEL._AC_SL1500_.jpg",
                    "description": "お風呂の残り湯を清潔に保つ、塩素剤配合の風呂水清浄剤",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B07Q9MJKBV"
                },
                {
                    "id": "B09B8W5FX7",
                    "category": "living-carpet",
                    "name": "アイリスオーヤマ リンサークリーナー",
                    "price": 12800,
                    "rating": 4.2,
                    "reviews": 23456,
                    "image": "https://m.media-amazon.com/images/I/71qSaRTRL-L._AC_SL1500_.jpg",
                    "description": "カーペット・ソファ・車内清掃に最適な水で洗うクリーナー",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B09B8W5FX7"
                },
                {
                    "id": "B00MH4U9C4",
                    "category": "floor-flooring",
                    "name": "リンレイ オール床クリーナー",
                    "price": 698,
                    "rating": 4.4,
                    "reviews": 5432,
                    "image": "https://m.media-amazon.com/images/I/61Nh7HpCXkL._AC_SL1000_.jpg",
                    "description": "フローリング、ビニール床、タイルなど全ての床材に使える万能クリーナー",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B00MH4U9C4"
                },
                {
                    "id": "B074V5CJ4S",
                    "category": "toilet-toilet",
                    "name": "サンポール トイレ洗剤",
                    "price": 248,
                    "rating": 4.5,
                    "reviews": 12890,
                    "image": "https://m.media-amazon.com/images/I/61YxwMRPURL._AC_SL1000_.jpg",
                    "description": "頑固な尿石・黄ばみを強力に落とす酸性タイプのトイレ用洗剤",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B074V5CJ4S"
                },
                {
                    "id": "B07F3TT9FZ",
                    "category": "window-glass",
                    "name": "ガラスマジックリン",
                    "price": 298,
                    "rating": 4.3,
                    "reviews": 7654,
                    "image": "https://m.media-amazon.com/images/I/71hBf0lYWXL._AC_SL1500_.jpg",
                    "description": "拭きスジが残らない、速乾性ガラスクリーナー",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B07F3TT9FZ"
                },
                {
                    "id": "B08DPLDHZC",
                    "category": "kitchen-sink",
                    "name": "激落ちくん キッチン用",
                    "price": 398,
                    "rating": 4.4,
                    "reviews": 9876,
                    "image": "https://m.media-amazon.com/images/I/71Qh7rOYmvL._AC_SL1500_.jpg",
                    "description": "メラミンスポンジでシンクの水垢・茶渋を簡単除去",
                    "prime": true,
                    "inStock": false,
                    "url": "https://www.amazon.co.jp/dp/B08DPLDHZC"
                },
                {
                    "id": "B00UUBCVZ4",
                    "category": "bathroom-bathtub",
                    "name": "カビキラー",
                    "price": 548,
                    "rating": 4.6,
                    "reviews": 34567,
                    "image": "https://m.media-amazon.com/images/I/61H5d0nHKEL._AC_SL1200_.jpg",
                    "description": "浴室のカビを根こそぎ退治する強力カビ取り剤",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B00UUBCVZ4"
                },
                {
                    "id": "B07WD7JS31",
                    "category": "living-carpet",
                    "name": "ファブリーズ W除菌",
                    "price": 348,
                    "rating": 4.2,
                    "reviews": 6789,
                    "image": "https://m.media-amazon.com/images/I/61ZzJgL9RgL._AC_SL1080_.jpg",
                    "description": "99.9%除菌・消臭、カーペットやソファに最適",
                    "prime": false,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B07WD7JS31"
                },
                {
                    "id": "B086W9JQCT",
                    "category": "floor-flooring",
                    "name": "ウタマロクリーナー",
                    "price": 398,
                    "rating": 4.7,
                    "reviews": 19234,
                    "image": "https://m.media-amazon.com/images/I/51XxYR9VX6L._AC_SL1000_.jpg",
                    "description": "家中これ1本！床・壁・水回りまで使える中性クリーナー",
                    "prime": true,
                    "inStock": true,
                    "url": "https://www.amazon.co.jp/dp/B086W9JQCT"
                }
            ]
        };

        let productsData = null;
        let startMemory = null;

        // メモリ使用量を取得
        function getMemoryUsage() {
            if (performance.memory) {
                return {
                    used: (performance.memory.usedJSHeapSize / 1048576).toFixed(2),
                    total: (performance.memory.totalJSHeapSize / 1048576).toFixed(2),
                    limit: (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2)
                };
            }
            return null;
        }

        // メモリ情報を表示
        function updateMemoryInfo() {
            const memory = getMemoryUsage();
            const memoryDiv = document.getElementById('memoryInfo');
            
            if (memory) {
                const usagePercent = ((memory.used / memory.limit) * 100).toFixed(1);
                memoryDiv.innerHTML = `
                    <strong>メモリ使用状況:</strong><br>
                    使用中: ${memory.used} MB / ${memory.limit} MB (${usagePercent}%)<br>
                    割り当て済み: ${memory.total} MB<br>
                    開始時: ${startMemory ? startMemory.used + ' MB' : '計測中'}
                `;
            } else {
                memoryDiv.innerHTML = 'メモリ情報は利用できません（Chromeでご確認ください）';
            }
        }

        // 初期メモリを記録
        window.onload = () => {
            startMemory = getMemoryUsage();
            updateMemoryInfo();
            setInterval(updateMemoryInfo, 1000); // 1秒ごとに更新
        };

        // 商品を読み込む
        function loadProducts() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="loading">商品データを読み込み中...</div>';
            
            try {
                // fetchを使わずに直接データを参照
                productsData = JSON.parse(JSON.stringify(masterProductsData));
                
                statusDiv.innerHTML = `<div class="success">✅ ${productsData.products.length}件の商品を読み込みました</div>`;
                
                displayProducts(productsData.products);
                checkMemory();
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">❌ エラー: ${error.message}</div>`;
                console.error('Error loading products:', error);
            }
        }

        // 商品を表示
        function displayProducts(products) {
            const container = document.getElementById('productContainer');
            container.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    <div class="product-title">${product.name}</div>
                    <div class="product-price">¥${product.price.toLocaleString()}</div>
                    <div class="product-rating">★${product.rating} (${product.reviews}件のレビュー)</div>
                    <div class="product-meta">
                        ${product.prime ? '✓ Prime' : ''} 
                        ${product.inStock ? '在庫あり' : '在庫なし'}
                    </div>
                    <div class="product-meta">
                        カテゴリー: ${product.category}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // カテゴリーでフィルター
        function filterProducts() {
            if (!productsData) return;
            
            const category = document.getElementById('categorySelect').value;
            const filtered = category === 'all' 
                ? productsData.products 
                : productsData.products.filter(p => p.category === category);
            
            displayProducts(filtered);
            
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="success">フィルター適用: ${filtered.length}件の商品を表示</div>`;
        }

        // クリア
        function clearProducts() {
            productsData = null;
            document.getElementById('productContainer').innerHTML = '';
            document.getElementById('status').innerHTML = '<div class="success">✅ クリアしました</div>';
            
            // ガベージコレクションを促す
            if (window.gc) {
                window.gc();
            }
            
            setTimeout(checkMemory, 100);
        }

        // メモリ確認
        function checkMemory() {
            const memory = getMemoryUsage();
            if (memory && startMemory) {
                const increase = (memory.used - startMemory.used).toFixed(2);
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML += `<div class="success">メモリ増加量: ${increase} MB</div>`;
            }
            updateMemoryInfo();
        }

        // ストレステスト
        function stressTest() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="loading">ストレステスト実行中...</div>';
            
            const startTime = Date.now();
            const iterations = 1000;
            
            try {
                for (let i = 0; i < iterations; i++) {
                    // fetchを使わずに直接データをコピー
                    const data = JSON.parse(JSON.stringify(masterProductsData));
                    
                    if (i % 100 === 0) {
                        statusDiv.innerHTML = `<div class="loading">ストレステスト実行中... ${i}/${iterations}</div>`;
                        updateMemoryInfo();
                    }
                }
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                statusDiv.innerHTML = `<div class="success">
                    ✅ ストレステスト完了<br>
                    実行回数: ${iterations}回<br>
                    所要時間: ${duration}秒<br>
                    平均: ${(duration / iterations * 1000).toFixed(2)}ms/回
                </div>`;
                
                checkMemory();
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">❌ ストレステストエラー: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>